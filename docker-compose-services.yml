services:

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - software_suite
    healthcheck:
      test: [ "CMD-SHELL", "curl -u elastic:${ELASTIC_PASSWORD} -f http://localhost:9200/_cluster/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    restart: unless-stopped
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_SERVICEACCOUNTTOKEN=${KIBANA_TOKEN}
      - SERVERNAME=kibana
      - SERVER_PUBLICBASEURL=http://localhost:5601
    ports:
      - "5601:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - software_suite

  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    restart: unless-stopped
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        gitlab_rails['initial_root_password'] = '${GITLAB_ROOT_PASSWORD}'
    ports:
      - "${GITLAB_HTTP_PORT:-8080}:80"
      - "${GITLAB_HTTPS_PORT:-8443}:443"
      - "${GITLAB_SSH_PORT:-2222}:22"
    volumes:
      - gitlab_config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab
    networks:
      - software_suite
    shm_size: '256m'

  #  docker exec -i postgres_db psql -U postgres -c "CREATE DATABASE jira;"
  #  docker exec -i postgres_db psql -U postgres -c "CREATE DATABASE confluence;"

  jira:
    image: atlassian/jira-software:latest
    container_name: jira
    restart: unless-stopped
    environment:
      - ATL_TOMCAT_MGMTPORT=8005
      - SETENV_JVM_MINIMUM_MEMORY=${JIRA_MIN_MEMORY:-1024m}
      - SETENV_JVM_MAXIMUM_MEMORY=${JIRA_MAX_MEMORY:-2048m}
      - ATL_JDBC_URL=jdbc:postgresql://postgres:5432/${JIRA_DB_NAME:-jira}
      - ATL_JDBC_USER=${DATABASE_USER}
      - ATL_JDBC_PASSWORD=${DATABASE_PASSWORD}
      - ATL_DB_TYPE=postgres72
    ports:
      - "${JIRA_PORT:-8090}:8080"
    volumes:
      - jira_data:/var/atlassian/application-data/jira
    depends_on:
      - postgres
    networks:
      - software_suite

  confluence:
    image: atlassian/confluence-server:latest
    container_name: confluence
    restart: unless-stopped
    environment:
      - ATL_TOMCAT_MGMTPORT=8000
      - SETENV_JVM_MINIMUM_MEMORY=${CONFLUENCE_MIN_MEMORY:-1024m}
      - SETENV_JVM_MAXIMUM_MEMORY=${CONFLUENCE_MAX_MEMORY:-2048m}
      - ATL_JDBC_URL=jdbc:postgresql://postgres:5432/${CONFLUENCE_DB_NAME:-confluence}
      - ATL_JDBC_USER=${DATABASE_USER}
      - ATL_JDBC_PASSWORD=${DATABASE_PASSWORD}
      - ATL_DB_TYPE=postgresql
    ports:
      - "${CONFLUENCE_PORT:-8091}:8090"
    volumes:
      - confluence_data:/var/atlassian/application-data/confluence
    depends_on:
      - postgres
    networks:
      - software_suite

volumes:
  postgres_data:
  elasticsearch_data:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
  jira_data:
  confluence_data:

networks:
  software_suite:
    driver: bridge
